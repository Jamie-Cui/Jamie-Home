---
layout: post
title:  "比特币钱包 --- Bitcoin Wallet"
date:   2018-6-7 12:00:00 +0000
categories: jekyll update
---
{% include add_favicon.html %}
{% include add_views.html %}

<span id="busuanzi_container_page_pv">
   views: <span id="busuanzi_value_page_pv"></span>
</span>

全文翻译自[比特币百科](https://bitcoin.org/en/developer-guide#wallets)。

# 比特币钱包

这篇博文会讲解比特币钱包的方方面面，可以说是面对零基础的一个基础入门，也相当与我对自己掌握知识的一个复习吧。XD

比特币钱包，按照官网上的定义就是一个用来管理用户比特币帐号的一个软件。根据官网上的定义，比特币钱包按照根据功能分为一下几类：全服务钱包、签名钱包、离线钱包、硬件钱包和仅分发钱包。

## 密钥格式 (secp256k1 ECDSA)

在比特币中，私钥和公钥是比特币账户惟一的标识符。用户可以使用私钥来进行数字签名从而发起转账，或者使用公钥作为收款地址来接受比特币。需要明白的是一般情况下建立比特币帐号会生成一个私钥 ，再根据私钥生成密钥。

1. 私钥 32byte - 256bit
2. 未压缩公钥 65byte - 520bit
3. 压缩公钥 33byte - 264bit

比特币的公钥在转账中的作用是接受转账，因此公钥会在比特币网络中被多次复制，很显然虽然公钥不需要安全性，但是我们需要保证在赋值粘贴过程中如果发生错误公钥可以做到自我检测（和checksum相似），因此比特币定义了在比特币钱包中公钥的格式WIF(wallet import format)来增强公钥的鲁棒性。具体方法如下：

1. 在公钥地址前加上一字节，对于比特币网络是0x80，对于测试网络是0xef
2. 如果是压缩的公钥，在公钥地址之后加一个字节0x01;如果是未压缩公钥，跳过
3. 对延长后的公钥使用SHA256求hash
4. 再次使用SHA256求hash
5. 取第二次hash结果的前4个byte作为检验和
6. 将四个检验和的byte放到延长后的公钥之前，生成新的公钥
7. 使用bash58将byte转换成string

而对于私钥来说，也需要将其转换成string格式，Mini private key format，具体生成方式如下：

1. 首字节为'S'
2. 为了检查私钥是不是使用了Mini private key,私钥中添加了'?'
3. 计算sha256，在私钥中随机添加随机数，直到生成的sha256前两个字节均为'0'
4. 为了取回私钥，直接计算sha256（？）

ECDSA公钥私钥又名椭圆曲线数字签名，针对的是未被压缩的公钥和私钥(y^2=x^3+7)。在ECDSA中，曲线中某个点为公钥，65byte，其中1个byte为指示曲线上方或者曲线下方，32byte y坐标， 32byte x坐标。

y^2 = x^3 + a，（下图显示了椭圆函数的图）具体算法很复杂。<img src="{{site.url}}{{site.baseurl}}/img/ECDSA.png" alt="Drawing" style="width: 600px;"/>


## HD钱包(BIP32 and BIP44)

为什么要提出HD钱包？比特币系统希望用户每次转账都随机生成密钥来使用，因为这样的话比特币钱包的安全性就不仅局限于一对密钥的安全，成功盗取账户就需要盗取账户所有的密钥。

对于用户来说使用随机密钥会使账户风险大大降低，但是从另一方面来看，使用随机密钥会要求比特币钱包进行频繁的备份。因此为了避免每次转账之后都需要对本次使用的密钥进行备份，默认情况下比特币钱包会又有一个容量为100个密钥的密钥池，每次随机生成的密钥都从密钥池中选取。但是依然，同时间只允许一个密钥被使用。

> 为什么通常情况下钱包需要备份？首先比特币的转账分为两部分，转账的发起者和转账的接收者。而每一个比特币账户都持有特定的一对标记符（公钥和私钥），简单的说公钥的作用是接受比特币而私钥的作用是进行数字签名以花出比特币。因此在一笔比特币转账中，会记录转账发起者的数字签名以及转账接收者的公钥信息。那么接下来就是比特币的状态机机制了，比特币系统中不以帐号为单位保存帐号余额，而是以上一笔转账验证的形式来完成下一笔转账。简单的来说如果我现在想花5个比特币，那么在发起转账是比特币系统不会要求我提供信息证明自己帐号余额中有5个比特币，而是要我证明之前有5比特币的转账记录是由我作为接收者。以此在比特币钱包中如果要管理多个密钥对，那么一定要对之前用过的密钥对进行备份，以用来花费转账到之前公钥地址的比特币。

HD钱包很好的解决了这个问题，HD钱包不需要频繁的进行密钥备份，而椭圆曲线数学公式允许在不泄露私钥的情况下计算出公钥。